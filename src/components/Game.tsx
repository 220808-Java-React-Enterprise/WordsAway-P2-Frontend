import React, { useState, useEffect } from 'react'
import TopBanner from './game/TopBanner'
import MainBoard from './game/MainBoard'
import SecondaryBoard from './game/SecondaryBoard'
import Tray from './game/Tray'
import BottomBanner from './game/BottomBanner'
import { DndProvider } from 'react-dnd'
import { HTML5Backend } from 'react-dnd-html5-backend'

const Game = () => {
    const [users, setUsers] = useState([
        {"username": "Player"},
        {"username": "Opponent"}
    ])
    const [board, setboard] = useState([
        {

            "letters": [
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", "."
            ]
        }
            
])
    const [move, setMove] = useState([{
        "move": [
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
            ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", "."
        ]
    }])

    const [tray, setTray] = useState([
        { "value": [".", ".", ".", ".", ".", ".", "."]}
    ])

    useEffect(()=>{
        setboard([
            {

                
                "letters": [
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", "f", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", "p", ".", "e", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", "a", ".", "t", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", "a", "n", "a", "c", "o", "n", "d", "a", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", "c", ".", "h", ".", ".", ".", "p", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", "a", ".", ".", ".", ".", ".", "p", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", "k", ".", ".", ".", ".", "l", "l", "a", "m", "a", ".", ".",
                    ".", ".", ".", ".", "e", ".", ".", ".", ".", ".", "e", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                    ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", "."
                ]
            }
        ])
        setMove([{
            "move": [
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".",
                ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", "."
            ]
        }])
        setTray([
            { "value": ["a", "b", "c", "d", "e", "f", "g"] }
        ])
    },[])

    useEffect(()=>{
        sessionStorage.setItem('board', JSON.stringify(board))
        sessionStorage.setItem('move', JSON.stringify(move))
        sessionStorage.setItem('tray', JSON.stringify(tray))
    })

    function updateGame(inOb:string, outOb:string, inN:number, outN:number, letter:string){
        console.log("Letter: " + letter)
        console.log("From: " + outOb + " at " + outN)
        console.log("To: " + inOb + " at " + inN)

        // changing outgoing cells
        var OOut = [], OIn = [], NOut:string[] = [], NIn:string[] = []
        if (outOb=='traytile' && inOb == 'boardtile'){
            OOut = JSON.parse(sessionStorage.tray)[0].value
            OIn = JSON.parse(sessionStorage.move)[0].move

            for (let i = 0; i< OOut.length; i++) {
                if (i==outN){NOut.push(".")}else{NOut.push(OOut[i])}
            }
            for (let i = 0; i < OIn.length; i++) {
                if (i == inN) {NIn.push(letter)} else {NIn.push(OIn[i])}
            }
            setTray([{ "value": NOut }])
            setMove([{ "move": NIn }])
            
        } else if (outOb == 'movetile' && inOb == 'boardtile'){
            
            OIn = JSON.parse(sessionStorage.move)[0].move

            for (let i = 0; i < OIn.length; i++) {
                if (i == inN) { NIn.push(letter) 
                } else if (i == outN) { NIn.push(".") 
                }else { NIn.push(OIn[i]) }
            }
            setMove([{ "move": NIn }])
        } else if (outOb == 'movetile' && inOb == 'emptytraytile'){
            OIn = JSON.parse(sessionStorage.tray)[0].value
            OOut = JSON.parse(sessionStorage.move)[0].move

            for (let i = 0; i < OOut.length; i++) {
                if (i == outN) { NOut.push(".") } else { NOut.push(OOut[i]) }
            }
            for (let i = 0; i < OIn.length; i++) {
                if (i == inN) { NIn.push(letter) } else { NIn.push(OIn[i]) }
            }
            setTray([{ "value": NIn }])
            setMove([{ "move": NOut }])
        } else if (outOb == 'traytile' && inOb == 'emptytraytile') {

            OIn = JSON.parse(sessionStorage.tray)[0].value

            for (let i = 0; i < OIn.length; i++) {
                if (i == inN) {
                    NIn.push(letter)
                } else if (i == outN) {
                    NIn.push(".")
                } else { NIn.push(OIn[i]) }
            }
            setTray([{ "value": NIn }])
        }

        

   



    }



  return (
    
    <div className='game'>
        <DndProvider backend={HTML5Backend}>
            <TopBanner name={users[1].username}/>
            <div className='boards'>
                <MainBoard moves={move[0].move} updateGame={updateGame} letters={board[0].letters} />
                <SecondaryBoard />
            </div>
            
              <Tray updateGame={updateGame} trayletters={tray[0].value} />
                    
            
              <BottomBanner name={users[0].username}/>
        </DndProvider>
    </div>
    
  )
}

export default Game